name: Continuous Integration

# Script akan berjalan saat ada push atau Pull Request ke branch main atau master
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  test-and-e2e:
    runs-on: ubuntu-latest

    steps:
      # 1. Mengambil kode dari repository
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Menyiapkan environment Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Menginstal semua dependencies
      - name: Install Dependencies
        run: npm ci --legacy-peer-deps

      # 4. Menjalankan Unit & Integration Test (Vitest)
      # GitHub Actions otomatis menetapkan variabel CI=true, sehingga Vitest tidak akan hang
      - name: Run Unit Tests
        run: npm test

      # 5. Menjalankan E2E Test (Cypress)
      - name: Run Cypress E2E Tests
        uses: cypress-io/github-action@v6
        with:
          # Menjalankan server Vite di latar belakang
          start: npm run dev
          # Menunggu hingga server siap menerima request
          wait-on: 'http://localhost:5173'